#!/usr/bin/env bash
set -euo pipefail

BUILD_DIR="$1"

# ===== 設定（Heroku config var で渡す） =====
: "${GITHUB_REPO:?Set GITHUB_REPO like takahiro-yonei/heroku-buildpack-ffmpeg-runtime}"
: "${FFMPEG_RELEASE_TAG:?Set FFMPEG_RELEASE_TAG like heroku24-n6.1.1}"

ASSET="ffmpeg-lgpl-heroku24-x86_64.tar.gz"
URL="https://github.com/${GITHUB_REPO}/releases/download/${FFMPEG_RELEASE_TAG}/${ASSET}"

echo "-----> Installing LGPL ffmpeg from GitHub Releases"
echo "       $URL"

# ===== 展開 =====
mkdir -p "$BUILD_DIR/.ffmpeg"
curl -fsSL "$URL" | tar -xz -C "$BUILD_DIR/.ffmpeg" --strip-components=1

# ===== runtime 環境変数 =====
mkdir -p "$BUILD_DIR/.profile.d"
cat > "$BUILD_DIR/.profile.d/010_ffmpeg.sh" <<'EOF'
export PATH="$HOME/.ffmpeg/bin:$PATH"
export LD_LIBRARY_PATH="$HOME/.ffmpeg/lib:${LD_LIBRARY_PATH:-}"
EOF

chmod +x "$BUILD_DIR/.profile.d/010_ffmpeg.sh"

echo "-----> ffmpeg installed"